<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Profile Settings - Kingdom Wealth</title>
    
    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

    <!-- TAILWIND & SUPABASE -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#f9f506",
                        "background-dark": "#0a192f",
                        "surface-dark": "#112240",
                        "text-main": "#ffffff",
                        "text-muted": "#94a3b8",
                    },
                    fontFamily: { "display": ["Spline Sans", "sans-serif"] }
                },
            },
        }
    </script>
</head>

<body class="bg-background-dark font-display text-text-main flex min-h-screen items-center justify-center p-4">

    <!-- SETTINGS CARD -->
    <div class="w-full max-w-md bg-surface-dark border border-white/10 rounded-3xl shadow-2xl p-6 md:p-8">
        
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <h2 class="text-2xl font-bold">Edit Profile</h2>
            <a href="dash.html" class="flex items-center gap-1 text-sm text-text-muted hover:text-primary transition-colors">
                <span class="material-symbols-outlined text-lg">close</span> Cancel
            </a>
        </div>

        <form id="settingsForm" onsubmit="saveData(event)" class="space-y-6">
            
            <!-- 1. IMAGE UPLOAD -->
            <div class="flex flex-col items-center gap-4">
                <div class="relative group cursor-pointer" onclick="document.getElementById('fileUpload').click()">
                    <!-- Profile Image -->
                    <img id="previewImg" 
                         src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png" 
                         class="w-28 h-28 rounded-full object-cover border-4 border-white/10 group-hover:border-primary transition-all shadow-lg">
                    
                    <!-- Overlay Icon -->
                    <div class="absolute inset-0 flex items-center justify-center rounded-full bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="material-symbols-outlined text-white text-3xl">photo_camera</span>
                    </div>
                </div>
                <input type="file" id="fileUpload" accept="image/*" class="hidden" onchange="convertImage(event)">
                <p class="text-xs text-text-muted">Tap image to update</p>
            </div>

            <!-- 2. FULL NAME -->
            <div class="space-y-2">
                <label class="text-xs font-bold text-text-muted uppercase tracking-wider">Full Name</label>
                <div class="relative">
                    <span class="absolute left-4 top-3.5 text-gray-500 material-symbols-outlined text-lg">person</span>
                    <input type="text" id="nameInput" 
                           class="w-full bg-[#0a192f] border border-white/10 rounded-xl pl-12 pr-4 py-3 text-white focus:outline-none focus:border-primary transition-colors placeholder-gray-600" 
                           placeholder="Enter your full name">
                </div>
            </div>

            <!-- 3. PHONE NUMBER -->
            <div class="space-y-2">
                <label class="text-xs font-bold text-text-muted uppercase tracking-wider">Phone Number</label>
                <div class="flex gap-3">
                    <!-- Country Code -->
                    <div class="relative w-28">
                        <select id="countryCode" class="w-full bg-[#0a192f] border border-white/10 rounded-xl px-3 py-3 text-white focus:outline-none focus:border-primary appearance-none cursor-pointer">
                            <option value="+234">ðŸ‡³ðŸ‡¬ +234</option>
                            <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
                            <option value="+44">ðŸ‡¬ðŸ‡§ +44</option>
                            <option value="+233">ðŸ‡¬ðŸ‡­ +233</option>
                            <option value="+27">ðŸ‡¿ðŸ‡¦ +27</option>
                        </select>
                        <span class="absolute right-2 top-3.5 text-gray-500 material-symbols-outlined text-sm pointer-events-none">expand_more</span>
                    </div>
                    
                    <!-- Number Input -->
                    <input type="tel" id="phoneInput" 
                           class="flex-1 bg-[#0a192f] border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-primary placeholder-gray-600" 
                           placeholder="801 234 5678">
                </div>
            </div>

            <!-- READ ONLY EMAIL -->
            <div class="space-y-2 opacity-50">
                <label class="text-xs font-bold text-text-muted uppercase tracking-wider">Email Address (Locked)</label>
                <input type="text" id="emailDisplay" disabled 
                       class="w-full bg-[#0a192f] border border-white/10 rounded-xl px-4 py-3 text-gray-400 cursor-not-allowed" 
                       value="Loading...">
            </div>

            <!-- SAVE BUTTON -->
            <button type="submit" class="w-full bg-primary hover:bg-yellow-400 text-black font-bold py-3.5 rounded-xl transition-transform active:scale-95 shadow-lg shadow-primary/20 flex items-center justify-center gap-2 mt-4">
                Save Changes
                <span class="material-symbols-outlined text-lg">save</span>
            </button>

        </form>
    </div>

    <!-- LOGIC -->
    <script>
        // 1. SUPABASE SETUP
        const _supabaseUrl = 'https://dmscgsujriqmpwkovecr.supabase.co';
        const _supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtc2Nnc3VqcmlxbXB3a292ZWNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMzAzOTUsImV4cCI6MjA4MTYwNjM5NX0.RIsIthkxxnHIFvNBps6T-qzszq_M9GgUiNhdfbky28k';
        const _supabase = supabase.createClient(_supabaseUrl, _supabaseAnonKey);

        let currentUser = null;

        // 2. ON LOAD
        window.onload = async function() {
            // A. Check Auth
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) {
                window.location.href = "login.html";
                return;
            }
            currentUser = user;
            document.getElementById('emailDisplay').value = user.email;

            // B. Load from LocalStorage (Fast)
            const savedImg = localStorage.getItem('kw_profile_pic');
            const savedName = localStorage.getItem('kw_username');
            const savedPhone = localStorage.getItem('kw_phone');
            const savedCode = localStorage.getItem('kw_country_code');

            if(savedImg) document.getElementById('previewImg').src = savedImg;
            if(savedName) document.getElementById('nameInput').value = savedName;
            if(savedPhone) document.getElementById('phoneInput').value = savedPhone;
            if(savedCode) document.getElementById('countryCode').value = savedCode;

            // C. Load from Database (Sync)
            const { data: profile } = await _supabase
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .single();

            if (profile && profile.full_name) {
                document.getElementById('nameInput').value = profile.full_name;
                localStorage.setItem('kw_username', profile.full_name);
            }
        }

        // 3. HANDLE IMAGE PREVIEW
        function convertImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = function() {
                    // Update UI immediately
                    document.getElementById('previewImg').src = reader.result;
                    // Save to LocalStorage
                    localStorage.setItem('kw_profile_pic', reader.result);
                }
                reader.readAsDataURL(file);
            }
        }

        // 4. SAVE DATA
        async function saveData(event) {
            event.preventDefault();
            
            const btn = document.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="material-symbols-outlined animate-spin text-lg">sync</span> Saving...`;
            btn.disabled = true;

            const name = document.getElementById('nameInput').value;
            const phone = document.getElementById('phoneInput').value;
            const code = document.getElementById('countryCode').value;

            try {
                // A. Save to LocalStorage
                localStorage.setItem('kw_username', name);
                localStorage.setItem('kw_phone', phone);
                localStorage.setItem('kw_country_code', code);

                // B. Save to Supabase DB
                const { error } = await _supabase
                    .from('profiles')
                    .update({ 
                        full_name: name,
                        // Note: If you have a phone column in DB, add: phone: code + phone
                    })
                    .eq('id', currentUser.id);

                if(error) throw error;

                alert("Profile Updated Successfully!");
                window.location.href = "dash.html";

            } catch (err) {
                console.error("Save Error:", err);
                // Even if DB fails, LocalStorage worked, so we proceed
                alert("Saved locally! (Cloud sync failed: " + err.message + ")");
                window.location.href = "dash.html";
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
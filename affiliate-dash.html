<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>KW Affiliate Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700&display=swap" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = { darkMode: "class", theme: { extend: { colors: { "primary": "#f9f506", "dark-bg": "#050510" }, fontFamily: { "display": ["Manrope", "sans-serif"] } } } }
    </script>
</head>
<body class="bg-dark-bg font-display text-white p-6 flex flex-col items-center">

    <div class="w-full max-w-lg bg-[#111118] border border-white/10 rounded-2xl p-8 shadow-2xl">
        <h1 class="text-3xl font-bold text-center mb-2">Affiliate <span class="text-primary">Portal</span></h1>
        <p class="text-gray-400 text-center text-sm mb-8">Promote our digital products & earn 20% instantly.</p>

        <!-- REGISTER SECTION -->
        <div id="registerSection" class="hidden">
            <button onclick="becomeAffiliate()" class="w-full py-4 bg-primary text-black font-bold rounded-xl hover:bg-white transition-all shadow-lg">
                Generate My Affiliate Link
            </button>
        </div>

        <!-- DASHBOARD SECTION -->
        <div id="dashSection" class="hidden space-y-6">
            
            <!-- Link Box -->
            <div class="bg-black/40 p-4 rounded-xl border border-white/10">
                <p class="text-xs text-gray-400 uppercase font-bold mb-2">Your Unique Link</p>
                <div class="flex gap-2">
                    <input id="affLink" readonly class="w-full bg-transparent text-primary font-mono text-sm outline-none">
                    <button onclick="copyLink()" class="text-gray-400 hover:text-white">Copy</button>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white/5 p-4 rounded-xl text-center">
                    <p class="text-xs text-gray-400">Total Earned</p>
                    <h2 id="totalEarned" class="text-2xl font-bold text-green-400">₦0</h2>
                </div>
                <div class="bg-white/5 p-4 rounded-xl text-center">
                    <p class="text-xs text-gray-400">Wallet Balance</p>
                    <h2 id="walletBal" class="text-2xl font-bold text-white">₦0</h2>
                </div>
            </div>

            <button onclick="window.location.href='dash.html'" class="w-full py-3 border border-white/20 rounded-xl hover:bg-white/10 transition-colors">
                Go to Main Dashboard to Withdraw
            </button>
        </div>
    </div>

    <script>
        const _supabaseUrl = 'https://dmscgsujriqmpwkovecr.supabase.co';
        const _supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtc2Nnc3VqcmlxbXB3a292ZWNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMzAzOTUsImV4cCI6MjA4MTYwNjM5NX0.RIsIthkxxnHIFvNBps6T-qzszq_M9GgUiNhdfbky28k';
        const _supabase = supabase.createClient(_supabaseUrl, _supabaseAnonKey);
        let userProfile = null;

        window.onload = async function() {
            const { data: { user } } = await _supabase.auth.getUser();
            if(!user) return window.location.href = 'login.html';

            // Get Profile
            const { data: profile } = await _supabase.from('profiles').select('*').eq('id', user.id).single();
            userProfile = profile;

            if (profile.is_affiliate) {
                showDash(profile);
            } else {
                document.getElementById('registerSection').classList.remove('hidden');
            }
        };

        async function becomeAffiliate() {
            // Generate Code: KW + First 3 letters of name + Random Num
            const namePart = userProfile.full_name ? userProfile.full_name.substring(0,3).toUpperCase() : 'USR';
            const random = Math.floor(1000 + Math.random() * 9000);
            const code = `KW-${namePart}-${random}`;

            const { error } = await _supabase.from('profiles').update({
                is_affiliate: true,
                referral_code: code
            }).eq('id', userProfile.id);

            if(error) alert("Error: " + error.message);
            else location.reload();
        }

        function showDash(profile) {
            document.getElementById('dashSection').classList.remove('hidden');
            
            const link = `https://kingdomwealthltd.com/digital-store.html?ref=${profile.referral_code}`;
            document.getElementById('affLink').value = link;
            
            document.getElementById('totalEarned').innerText = "₦" + Number(profile.total_earnings).toLocaleString();
            document.getElementById('walletBal').innerText = "₦" + Number(profile.wallet_balance).toLocaleString();
        }

        function copyLink() {
            const copyText = document.getElementById("affLink");
            copyText.select();
            navigator.clipboard.writeText(copyText.value);
            alert("Link Copied!");
        }
    </script>
</body>
</html>

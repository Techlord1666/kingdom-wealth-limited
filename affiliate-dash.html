<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>KW Affiliate Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = { 
            darkMode: "class", 
            theme: { 
                extend: { 
                    colors: { "primary": "#f9f506", "dark-bg": "#050510" }, 
                    fontFamily: { "display": ["Manrope", "sans-serif"] } 
                } 
            } 
        }
    </script>
    <style>
        /* Prevents horizontal scrolling on tiny screens */
        body { overflow-x: hidden; }
        .break-all { word-break: break-all; }
    </style>
</head>
<body class="bg-dark-bg font-display text-white p-4 md:p-8 flex flex-col items-center min-h-screen">

    <!-- NAV -->
    <nav class="w-full max-w-4xl flex justify-between items-center mb-6 md:mb-10">
        <div class="flex items-center gap-2">
            <span class="text-primary font-bold text-lg md:text-xl">KW Partners</span>
            <span class="bg-primary/20 text-primary text-[9px] md:text-[10px] px-2 py-0.5 rounded uppercase font-bold">Dashboard</span>
        </div>
        <button onclick="logout()" class="text-sm text-gray-400 hover:text-white border border-white/10 px-3 py-1 rounded-lg">Logout</button>
    </nav>

    <div class="w-full max-w-4xl space-y-6">
        
        <!-- MAIN STATS CARD -->
        <div class="bg-[#111118] border border-white/10 rounded-2xl p-5 md:p-8 shadow-2xl">
            <h2 id="welcomeName" class="text-lg md:text-xl font-bold mb-6 text-center md:text-left">Welcome, Partner</h2>
            
            <!-- Stats Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Wallet -->
                <div class="bg-black/40 p-4 rounded-xl border border-white/5 flex flex-col justify-center">
                    <p class="text-xs text-gray-400 mb-1">Wallet Balance</p>
                    <h2 id="walletBal" class="text-2xl md:text-3xl font-bold text-primary truncate">₦0.00</h2>
                </div>
                <!-- Earnings -->
                <div class="bg-black/40 p-4 rounded-xl border border-white/5 flex flex-col justify-center">
                    <p class="text-xs text-gray-400 mb-1">Total Earnings</p>
                    <h2 id="totalEarned" class="text-xl md:text-2xl font-bold text-green-400 truncate">₦0.00</h2>
                </div>
                <!-- Code -->
                <div class="bg-black/40 p-4 rounded-xl border border-white/5 sm:col-span-2 lg:col-span-1">
                    <p class="text-xs text-gray-400 mb-1">Affiliate Code</p>
                    <div class="flex items-center justify-between gap-2">
                        <code id="affCode" class="text-lg font-bold text-white tracking-widest">...</code>
                        <button onclick="copyCode()" class="bg-primary/10 p-2 rounded-lg text-primary hover:bg-primary hover:text-black transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- WITHDRAWAL SECTION -->
            <div class="mt-8 pt-6 border-t border-white/10">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                    <h3 class="font-bold text-white">Withdraw Funds</h3>
                    <span id="bankDisplay" class="text-[11px] md:text-xs text-gray-500 bg-white/5 px-3 py-1 rounded-full border border-white/5">No Bank Added</span>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3">
                    <input id="withdrawAmount" type="number" placeholder="Amount (Min ₦1000)" 
                        class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-primary outline-none text-base">
                    <button onclick="handleWithdraw()" 
                        class="w-full sm:w-auto bg-primary text-black font-bold px-8 py-3 rounded-xl hover:bg-white transition-all shadow-lg active:scale-95">
                        Withdraw
                    </button>
                </div>
                <p class="text-[10px] text-gray-500 mt-3 text-center sm:text-left">Withdrawals are processed automatically within 24 hours.</p>
            </div>
        </div>

        <!-- LINK GENERATOR CARD -->
        <div class="bg-[#111118] border border-white/10 rounded-2xl p-5 md:p-6 shadow-xl">
            <h3 class="font-bold text-white mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                Your Affiliate Link
            </h3>
            <div class="bg-black/50 p-4 rounded-xl border border-white/5 break-all mb-4">
                <p id="fullLink" class="text-[11px] md:text-xs text-gray-400 font-mono leading-relaxed text-center md:text-left"></p>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <button onclick="copyLink()" class="py-3 border border-white/20 rounded-xl text-sm font-semibold hover:bg-white hover:text-black transition-all">
                    Copy Link
                </button>
                <a href="digital-store.html" target="_blank" class="flex items-center justify-center py-3 bg-white/5 rounded-xl text-primary text-sm font-semibold hover:underline">
                    Visit Store
                </a>
            </div>
        </div>

    </div>

   <script>
    const _supabaseUrl = 'https://dmscgsujriqmpwkovecr.supabase.co';
    const _supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtc2Nnc3VqcmlxbXB3a292ZWNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMzAzOTUsImV4cCI6MjA4MTYwNjM5NX0.RIsIthkxxnHIFvNBps6T-qzszq_M9GgUiNhdfbky28k';
    const _supabase = supabase.createClient(_supabaseUrl, _supabaseAnonKey);

    async function handleAffiliateSignUp(event) {
        event.preventDefault();
        const btn = document.querySelector('button[type="submit"]');
        const originalText = btn.innerText;
        btn.innerText = "Processing...";
        btn.disabled = true;

        const firstName = document.getElementById('firstName').value;
        const lastName = document.getElementById('lastName').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const bankName = document.getElementById('bankName').value;
        const accNum = document.getElementById('accNum').value;
        const accName = document.getElementById('accName').value;

        try {
            // 1. Create User
            const { data, error } = await _supabase.auth.signUp({
                email: email,
                password: password,
                options: { data: { full_name: firstName + " " + lastName } }
            });

            if (error) throw error;

            // 2. Generate Code
            const namePart = firstName.substring(0,3).toUpperCase();
            const random = Math.floor(1000 + Math.random() * 9000);
            const code = `KW-${namePart}-${random}`;

            // 3. WAIT & UPDATE (The Safety Delay)
            // We verify the profile exists before updating
            setTimeout(async () => {
                
                // Try to update existing profile
                const { error: updateError } = await _supabase
                    .from('profiles')
                    .update({
                        full_name: firstName + " " + lastName,
                        is_affiliate: true,
                        referral_code: code,
                        bank_name: bankName,
                        account_number: accNum,
                        account_name: accName
                    })
                    .eq('id', data.user.id);

                // If update fails (row doesn't exist), INSERT it manually
                if (updateError) {
                    await _supabase.from('profiles').insert([{
                        id: data.user.id,
                        email: email,
                        full_name: firstName + " " + lastName,
                        is_affiliate: true,
                        referral_code: code,
                        bank_name: bankName,
                        account_number: accNum,
                        account_name: accName
                    }]);
                }

                alert("Registration Successful! Redirecting to Dashboard...");
                window.location.href = "affiliate-dash.html";

            }, 2000); // 2 second safety delay

        } catch (err) {
            alert("Error: " + err.message);
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Become an Affiliate - Kingdom Wealth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700&display=swap" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = { darkMode: "class", theme: { extend: { colors: { "primary": "#f9f506", "dark-bg": "#050510", "card-bg": "#111118" }, fontFamily: { "display": ["Manrope", "sans-serif"] } } } }
    </script>
</head>
<body class="bg-dark-bg font-display text-white min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-lg bg-card-bg border border-white/10 rounded-2xl p-8 shadow-2xl">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-white mb-2">Join <span class="text-primary">KW Affiliates</span></h1>
            <p class="text-gray-400 text-sm">Earn 20% commission on every digital sale.</p>
        </div>

        <form onsubmit="handleAffiliateSignUp(event)" class="space-y-4">
            
            <!-- Personal Info -->
            <div class="grid grid-cols-2 gap-4">
                <input id="firstName" required class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none" placeholder="First Name">
                <input id="lastName" required class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none" placeholder="Last Name">
            </div>
            
            <input id="email" type="email" required class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none" placeholder="Email Address">
            <input id="password" type="password" required class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none" placeholder="Create Password">

            <!-- Bank Details (For Payouts) -->
            <div class="pt-4 border-t border-white/10">
                <p class="text-xs font-bold text-primary mb-3 uppercase">Payout Details</p>
                <div class="space-y-3">
                    <select id="bankName" required class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-gray-300 focus:border-primary outline-none">
                        <option value="">Select Bank</option>
                        <option value="GTBank">GTBank</option>
                        <option value="Zenith Bank">Zenith Bank</option>
                        <option value="UBA">UBA</option>
                        <option value="Access Bank">Access Bank</option>
                        <option value="First Bank">First Bank</option>
                        <option value="Kuda">Kuda</option>
                        <option value="OPay">OPay</option>
                        <option value="PalmPay">PalmPay</option>
                        <option value="Moniepoint">Moniepoint</option>
                    </select>
                    <input id="accNum" type="number" required class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none" placeholder="Account Number">
                    <input id="accName" required class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none" placeholder="Account Name">
                </div>
            </div>

            <button type="submit" class="w-full bg-primary text-black font-bold py-4 rounded-xl hover:bg-white transition-all shadow-lg mt-6">
                Register as Affiliate
            </button>
            
            <p class="text-center text-xs text-gray-500 mt-4">
                Already an agent? <a href="login.html" class="text-primary hover:underline">Login here</a>
            </p>
        </form>
    </div>

    <script>
        const _supabaseUrl = 'https://dmscgsujriqmpwkovecr.supabase.co';
        const _supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtc2Nnc3VqcmlxbXB3a292ZWNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMzAzOTUsImV4cCI6MjA4MTYwNjM5NX0.RIsIthkxxnHIFvNBps6T-qzszq_M9GgUiNhdfbky28k';
        const _supabase = supabase.createClient(_supabaseUrl, _supabaseAnonKey);

        async function handleAffiliateSignUp(event) {
            event.preventDefault();
            const btn = document.querySelector('button[type="submit"]');
            btn.innerText = "Processing...";
            btn.disabled = true;

            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const bankName = document.getElementById('bankName').value;
            const accNum = document.getElementById('accNum').value;
            const accName = document.getElementById('accName').value;

            try {
                // 1. Create User
                const { data, error } = await _supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: { data: { full_name: firstName + " " + lastName } }
                });

                if (error) throw error;

                // 2. Generate Affiliate Code
                const namePart = firstName.substring(0,3).toUpperCase();
                const random = Math.floor(1000 + Math.random() * 9000);
                const code = `KW-${namePart}-${random}`;

                // 3. Update Profile with Affiliate Status & Bank Details
                // Note: The profile row is created automatically by triggers usually, 
                // but we update it here to be sure or insert if needed.
                // We will wait 1 second for the trigger to create the profile first.
                setTimeout(async () => {
                    const { error: profileError } = await _supabase
                        .from('profiles')
                        .update({
                            is_affiliate: true,
                            referral_code: code,
                            bank_name: bankName,
                            account_number: accNum,
                            account_name: accName
                        })
                        .eq('id', data.user.id);

                    if (profileError) {
                        // Fallback: If update failed (maybe profile didn't exist yet), insert it
                         await _supabase.from('profiles').insert([{
                            id: data.user.id,
                            email: email,
                            full_name: firstName + " " + lastName,
                            is_affiliate: true,
                            referral_code: code,
                            bank_name: bankName,
                            account_number: accNum,
                            account_name: accName
                         }]);
                    }
                    
                    alert("Welcome to the Team! Redirecting to Dashboard...");
                    window.location.href = "affiliate-dash.html";
                }, 1500);

            } catch (err) {
                alert("Error: " + err.message);
                btn.innerText = "Register as Affiliate";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
